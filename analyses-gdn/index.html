<!DOCTYPE html>
<meta charset="utf-8">
<body>
<h1 style="text-align: center; font-family: 'Montserrat', sans-serif;"> Analyse des données du Grand Débat National </h1>
<h2 style="text-align: center; font-family: 'Montserrat', sans-serif;"> Analyse descriptive de la participation </h2>
<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Donnée</label>
						<select id="select_map">
							<option value="Population">Population</option>
							<option value="Count_all"]>Nbr de contribution</option>
							<option value="Count_pourmil" selected="selected">Nbr de contribution pour 1000 hbts</option>
							<option value="perc_fisc">% de contribution sur la fiscalité</option>
							<option value="perc_ecolo">% de contribution sur la l'écologie</option>
							<option value="perc_cit">% de contribution sur la citoyenneté</option>
							<option value="perc_etat">% de contribution sur l'organisation des services publics</option>
						</select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<div id="map"></div>
<!--
<h2 style="text-align: center; font-family: 'Montserrat', sans-serif;"> Annalyse par traitement automatique du langage naturel des questions ouvertes</h2>

<h4 style="text-align: center; font-family: 'Montserrat', sans-serif;"> Principale questions du grand débat annalysées avec l'algorithme Word2Vec + projection t-SNE</h4>
<div class="row white">
		<div style="text-align: center;"></div> 
		<div style="padding-bottom: 50px;">
			<form>
				<fieldset>
					<div>
						<label for="male">Questions</label>
						<select id="select_network">
							<option value="ecolo">Que faudrait-il faire selon vous pour apporter des réponses à ce problème ?</option>
							<option value="fisc"]>Que faudrait-il faire pour rendre la fiscalité plus juste et plus efficace ?</option>
							<option value="cit" selected="selected">Que faudrait-il faire pour renouer le liens entre les citoyens et les élus qui les représentent ?</option>
							<option value="etat">Que pensez-vous de l’or ganisation de l’Etat et des administrations en France ? De quelle manière cette organisation devrait-elle évoluer ?</option>
						</select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<div id="network"></div>
-->
<h2 style="text-align: center; font-family: 'Montserrat', sans-serif; padding-top:50px;"> Analyse descriptive des questions fermées</h2>
<h3 id="h_ecolo" style="text-align: center; font-family: 'Montserrat', sans-serif; padding-top:50px;">La transition écologique</h3>
<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Questions</label>
						<select id="select_chart_ecolo"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<div id="main_chart_ecolo" class="main_q">
	<div id="chart_ecolo" class="chart_m"></div>
</div>
<div id="main_chart_q_ecolo" class="main">
<div id="main_chart_q_ecolo" class="main">
	<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Réponses</label>
						<select id="select_resp_ecolo"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
	<div id="chart_q_ecolo" class="chart"></div>
	<div id="map_chart_ecolo" class="map"></div>
	
	</div>
</div>
<h3 id="h_fisc" style="text-align: center; font-family: 'Montserrat', sans-serif; padding-top:50px;">La fisaclité et les dépenses publics</h3>
<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Questions</label>
						<select id="select_chart_fisc"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<div id="main_chart_fisc" class="main_q">
	<div id="chart_fisc" class="chart_m"></div>
</div>
<div id="main_chart_q_fisc" class="main">
	<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Réponses</label>
						<select id="select_resp_fisc"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
	<div id="chart_q_fisc" class="chart"></div>
	<div id="map_chart_fisc" class="map"></div>
	
</div>


<h3 id="h_cit" style="text-align: center; font-family: 'Montserrat', sans-serif; padding-top:50px;">Démocratie et Citoyenneté</h3>
<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Questions</label>
						<select id="select_chart_cit"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<div id="main_chart_cit" class="main_q">
	<div id="chart_cit" class="chart_m"></div>
</div>
<div id="main_chart_q_cit" class="main">
	<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Réponses</label>
						<select id="select_resp_cit"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
	<div id="chart_q_cit" class="chart"></div>
	<div id="map_chart_cit" class="map"></div>
	
</div>
<h3 id="h_etat" style="text-align: center; font-family: 'Montserrat', sans-serif; padding-top:50px;">Organisation de l’Etat et des services publics</h3>
<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Questions</label>
						<select id="select_chart_etat"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<div id="main_chart_etat" class="main_q">
	<div id="chart_etat" class="chart_m"></div>
</div>
<div id="main_chart_q_etat" class="main">
	<div class="row white">
		<div style="text-align: center;"></div> <!-- Empty to center the next one -->
		<div>
			<form>
				<fieldset>
					<div>
						<label for="male">Réponses</label>
						<select id="select_resp_etat"></select>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
	<div id="chart_q_etat" class="chart"></div>
	<div id="map_chart_etat" class="map"></div>
	
</div>

<p class="footer" style="padding-top: 150px;" > Sources : Données ouvertes du GDN, Base de données infra communales (INSEE), Base Filosofi (INSEE), Calcul des auteurs <br>
*Les communes sont regroupés par code postal.</p>
<p class="footer" > Authors : <a href="https://twitter.com/LouisVlln">LouisVlln</a> - <a href="https://twitter.com/PA_veillon">PA_veillon</a> </p>
<p class="footer" > Contact : louis.veillon@gadz.org - paul-armand.veillon@polytechnique.org </p>

<link rel="stylesheet" href="color_panel.css">
<link rel="stylesheet" href="https://fonts.gstatic.com/s/montserrat/v12/JTURjIg1_i6t8kCHKm45_c5H3gnD_g.woff2">
<style>

#info {
	margin-top: 50px;
}

#deptinfo {
	margin-top: 30px;
}

.department {
	cursor: pointer;
	stroke: black;
	stroke-width: .5px;
}

.department:hover {
	stroke-width: 2px;
}

.button {
  background-color: #999999;
  border: none;
  color: white;
  padding: 10px 31px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
  margin: 4px 2px;
  cursor: pointer;
  float: right;
}

.button:hover {
  background-color: #c6c6c6; 
  color: white;
}

div.tooltip {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

div.tooltip_c {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

div.tooltip_n {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

div.tooltip_mc {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 40px;
}

#svg {
	display: block;
	margin: auto;
}

#svgn {
	display: block;
	margin: auto;
}

.svgc {
	display: block;
	margin: auto;
}

.svgm {
	display: block;
	float: left;
	margin: auto;
}


.footer {
	text-align: center;
	font-weight: 300;
	font-size:0.8em;
	font-style: italic;
}

.main {
    width: 1200px;
    height: 600px;
    margin: 0 auto;
   
}

.main_q {
    width: 1200px;
    height: 500px;
    margin: 0 auto;
   
}



.chart_m {
	width: 1200px;
	height: 500px;
	margin: 0 auto;
        
}
.chart {
	width: 600px;
	height: 500px;
	float: left;
}

.map{
    width: 600px;
    height: 500px;
    margin-left: 600px;
}

</style>
<body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script>
const width = 700, height = 550;

// Create a path object to manipulate geo data
const path = d3.geoPath();

// Define projection property
const projection = d3.geoConicConformal() // Lambert-93
	.center([2.454071, 46.279229]) // Center on France
	.scale(2600)
	.translate([width / 2 - 50, height / 2]);

path.projection(projection); // Assign projection to path object

// Create the DIV that will contain our map
const svg = d3.select('#map').append("svg")
	.attr("id", "svg")
	.attr("width", width)
	.attr("height", height)
	.attr("class", "Blues");

// Append the group that will contain our paths
const deps = svg.append("g");

var promises = [];
promises.push(d3.json('france.json'));
promises.push(d3.csv("GN_conso_dep_level.csv"));


var data_selected= "Count_pourmil";



function plot_map(values) {
	const geojson = values[0];
	const csv = values[1];
	var features = svg
		.selectAll("path")
		.data(geojson.features)
		.enter()
		.append("path")
		.attr('id', function(d) {return "d" + d.properties.CODE_DEPT;})
		.attr("d", path);

	// Quantile scales map an input domain to a discrete range, 0...max(population) to 1...9
	var quantile = d3.scaleQuantile()
		.domain([ d3.min(csv, function(e) { return +e[data_selected]; }), d3.max(csv, function(e) { return +e[data_selected]; })])
		.range(d3.range(9));

	var legend = svg.append('g')
		.attr('transform', 'translate(525, 150)')
		.attr('id', 'legend');
		
	legend.selectAll('.colorbar')
		.data(d3.range(9))
	  .enter().append('svg:rect')
		.attr('y', function(d) { return d * 20 + 'px'; })
		.attr('height', '20px')
		.attr('width', '20px')
		.attr('x', '0px')
		.attr("class", function(d) { return "q" + d + "-9"; });
			
	var legendScale = d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e[data_selected]; }), d3.max(csv, function(e) { return +e[data_selected]; })])
		.range([0, 9 * 20]);
		
	var legendAxis = svg.append("g")
		.attr('transform', 'translate(550, 150)')
		.call(d3.axisRight(legendScale).ticks(6));
		
	csv.forEach(function(e,i) {
		d3.select("#d" + e.CODE_DEPT)
			.attr("class", function(d) { return "department q" + quantile(+e[data_selected]) + "-9"; })
			.on("mouseover", function(d) {
				div.transition()        
					.duration(200)      
					.style("opacity", .9);
				div.html("<b>Département : </b>" + e.CODE_DEPT + "<br>"
						+ "<b>Valeur : </b>" + Math.round(e[data_selected]*100)/100 + "<br>")
					.style("left", (d3.event.pageX + 30) + "px")     
					.style("top", (d3.event.pageY - 30) + "px");
			})
			.on("mouseout", function(d) {
				div.style("opacity", 0);
				div.html("")
					.style("left", "-500px")
					.style("top", "-500px");
			});
	});
};

Promise.all(promises).then(plot_map);


var dic_color = {};
dic_color["Population"]="Blues";
dic_color["Count_all"]="Blues";
dic_color["Count_pourmil"]="Reds";
dic_color["perc_fisc"]="Reds";
dic_color["perc_ecolo"]="Greens";
dic_color["perc_cit"]="YlOrBr";
dic_color["perc_etat"]="PuBu";
// Refresh colors on combo selection
d3.select("#select_map").on("change", function() {
	d3.selectAll("#svg").attr("class", dic_color[this.value]);
	data_selected=this.value;
	svg.selectAll("*").remove();
	Promise.all(promises).then(plot_map);
	
});

// Append a DIV for the tooltip
var div = d3.select("body").append("div")   
	.attr("class", "tooltip")               
	.style("opacity", 0);


//---------------------------------------

/*
const svgn = d3.select('#network').append("svg")
	.attr("id", "svgn")
	.attr("width", width)
	.attr("height", height+50);

	
var data_selected_n = "ecolo";

var promises_n = [];
promises_n.push(d3.csv("embeddings_"+data_selected_n+".csv"));


function plot_n(values) {
	var width_ = +svgn.attr("width");
	var height_ = +svgn.attr("height");
	const divn = d3.select("body").append("div")
    		.attr("class", "tooltip_n")         
    		.style("opacity", 0);
	
	const csv = values[0];
	var linear_x= d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e["0"]; }), d3.max(csv, function(e) { return +e["0"]; })])
		.range([0,width]);
	var linear_y= d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e["1"]; }), d3.max(csv, function(e) { return +e["1"]; })])
		.range([0,height]);
	var linear_r= d3.scaleLinear()
		.domain([d3.min(csv, function(e) { return +e["degree"]; }), d3.max(csv, function(e) { return +e["degree"]; })])
		.range([0.7,12]);
	var features = svgn
		.selectAll("circle")
		.data(csv)
		.enter()
		.append("circle")
		.attr('cx', width/2)
		.attr("cy", height/2)
   		.attr("r", function(d) {return linear_r(d["degree"]);})
		.style("opacity", .8)
		.style("fill","#8bb1ef")
		.on("mouseover", function(d) {
				divn.transition()        
					.duration(200)      
					.style("opacity", .9);
				divn.html(d["word"])
					.style("left", (d3.event.pageX + 30) + "px")     
					.style("top", (d3.event.pageY - 30) + "px")
					.style("height","15px");
			})
		.on("mouseout", function(d) {
				div.style("opacity", 0);
				div.html("")
					.style("left", "-500px")
					.style("top", "-500px");
			});	
	
		
	
	features.transition()
			.duration(6000)
			.attr('cx', function(d) {return linear_x(d["0"]);})
			.attr("cy", function(d) {return linear_y(d["1"]);});
			
			
};

Promise.all(promises_n).then(plot_n);

d3.select("#select_network").on("change", function() {
	
	svgn.selectAll("*").remove();
	d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	promises_n.pop(d3.csv("embeddings_"+data_selected_n+".csv"));
	data_selected_n = this.value;
	promises_n.push(d3.csv("embeddings_"+data_selected_n+".csv"));
	Promise.all(promises_n).then(plot_n);


});	
	

		
*/


//--------------------------------------------------------------------------------

const margin_c = {top: 70, right: 20, bottom: 250, left: 120},
    width_c = 600 - margin_c.left - margin_c.right,
    height_c = 600 - margin_c.top - margin_c.bottom;

const x = d3.scaleBand()
    .range([0, width_c])
    .padding(0.3);

const y = d3.scaleLinear()
    .range([height_c, 0]);




promises.push(d3.csv("bd_questions_1.csv"));
promises.push(d3.csv("DEP_conso_QF_particpation.csv"));
promises.push(d3.csv("INSEE_conso_QF_particpation.csv"));


function plot_map_chart(values) {

	const geojson = values[0];
	const csv = values[2];
	const csv_dep = values[3];
        const csv_chart = values[4];
	const theme = values[5];
	
	
	
	const svgc = d3.select("#chart_"+theme).append("svg")
    		.attr("id", "svgc_"+theme)
                .attr("class","svgc")
    		.attr("width", width_c + margin_c.left + margin_c.right)
    		.attr("height", height_c + margin_c.top + margin_c.bottom)
    		.append("g")
    		.attr("transform", "translate(" + margin_c.left + "," + margin_c.top + ")")
		.attr("class",dic_color["perc_"+theme]);


	var title = d3.select("#map_chart_"+theme).append("h5")
				.attr("id","title_"+theme);
	

	    csv_theme = csv.filter(function(d) {return d.theme ==d3.select("#h_"+theme).text();});
	    var quest_id= d3.nest()
		.key(function(d) { return d.Id1; })
		//.value(function(d) { return d.question; })
		.entries(csv_theme);
	   
	    d3.select('#select_chart'+'_'+theme).selectAll('option')
		 	.data(quest_id)
			.enter()
			.append('option')
			.text(function(d) {return d.values[0].question;})
			.attr('value',function(d){return d.key;});

	var data_id_selected = d3.select('#select_chart_'+theme).node().value;
	var data_selected_c = csv_theme.filter(function(d) {return d.Id1 ==data_id_selected;});
	data_selected_c = data_selected_c[0]['CODE_DEPT'];

	title.html(data_selected_c+" en %")
	     .style("text-align","center");

	const svgm_c = d3.select('#map_chart_'+theme).append("svg")
		.attr("id", "svgm_"+theme)
		.attr("width", 600)
		.attr("height", 500)
		.attr("class", dic_color["perc_"+theme]+" svgm");

	var features = svgm_c
		.selectAll("path")
		.data(geojson.features)
		.enter()
		.append("path")
		.attr('id', function(d) {return "d_"+theme+"_" + d.properties.CODE_DEPT;})
		.attr("d", path);

	var csv_selected = csv.filter(function (d) { return d.Id1 == data_id_selected});


	var quantile_select = "% Ouvriers";
	d3.select('#select_resp'+'_'+theme).selectAll('option').remove();
	d3.select('#select_resp'+'_'+theme).selectAll('option')
	 	.data(csv_selected)
		.enter()
		.append('option')
		.text(function(d) {return d.CODE_DEPT;})
		.attr('value',function(d){return d.Id2;});
	// Quantile scales map an input domain to a discrete range, 0...max(population) to 1...9
	var quantile = d3.scaleQuantile()
		.domain([ d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }), d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; })])
		.range(d3.range(9));

	var legend = svgm_c.append('g')
		.attr('transform', 'translate(525, 150)')
		.attr('id', 'legend');
		
	legend.selectAll('.colorbar')
		.data(d3.range(9))
	  .enter().append('svg:rect')
		.attr('y', function(d) { return d * 20 + 'px'; })
		.attr('height', '20px')
		.attr('width', '20px')
		.attr('x', '0px')
		.attr("class", function(d) { return "q" + d + "-9"; });
			
	var legendScale = d3.scaleLinear()
		.domain([d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }), d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; })])
		.range([0, 9 * 20]);
		
	var legendAxis = svgm_c.append("g")
                .attr("id","legendt")
		.attr('transform', 'translate(550, 150)')
		.call(d3.axisRight(legendScale).ticks(6));

	
	
		
	csv_dep.forEach(function(e,i) {
		d3.select("#d_"+theme+"_" + e.CODE_DEPT)
			.attr("class", function(d) { return "department q" + quantile(+e[d3.select("#select_resp_"+theme).node().value]) + "-9"; })
			.on("mouseover", function(d) {
				div.transition()        
					.duration(200)      
					.style("opacity", .9);
				div.html("<b>Département : </b>" + e.CODE_DEPT + "<br>"
						+ "<b>Valeur : </b>" + Math.round(e[d3.select("#select_resp_"+theme).node().value]*100)/100 + "<br>")
					.style("left", (d3.event.pageX + 30) + "px")     
					.style("top", (d3.event.pageY - 30) + "px");
			})
			.on("mouseout", function(d) {
				div.style("opacity", 0);
				div.html("")
					.style("left", "-500px")
					.style("top", "-500px");
			});
	});
	   
	    const divc = d3.select("body").append("div")
    		.attr("class", "tooltip_c")         
    		.style("opacity", 0);

            const divmc = d3.select("body").append("div")
    		.attr("class", "tooltip_mc")         
    		.style("opacity", 0);
	    
            
	    
	    
		
	
	    // Conversion des caractères en nombres
	    csv.forEach(function(d) {
		d.total = parseInt(d.total);
               
	    });

            
	    
	    // Mise en relation du scale avec les données de notre fichier
	    // Pour l'axe X, c'est la liste des pays
	    // Pour l'axe Y, c'est le max des populations
	    x.domain(csv_selected.map(function(d) { return d.CODE_DEPT; }));
	    y.domain([0, d3.max(csv_selected, function(d) { return d.total; })]);

	    
	    // Ajout de l'axe X au SVG
	    // Déplacement de l'axe horizontal et du futur texte (via la fonction translate) au bas du SVG
	    // Selection des noeuds text, positionnement puis rotation
	    svgc.append("g")
		.attr("transform", "translate(0," + height_c + ")")
		.call(d3.axisBottom(x).tickSize(0))
		.selectAll("text")	
		    .attr("dx", "-.8em")
		    .attr("y","8")
		    //.attr("dy", "-.15em")
		    .call(wrap, 100);
		
	    function wrap(text, width) {
		    text.each(function() {
			var text = d3.select(this),
			words = text.text().split(/\s+/).reverse(),
			word,
			line = [],
			lineNumber = 0,
			y = text.attr("y"),
			dy = parseFloat(text.attr("dy")),
			lineHeight = 1.3, // ems
			tspan = text.text(null).append("tspan").attr("x", function(d) { return d.children || d._children ? -10 : 10; }).attr("y", 				y).attr("dy", dy + "em");     
			while (word = words.pop()) {
			    line.push(word);
			    tspan.text(line.join(" "));
			    var textWidth = tspan.node().getComputedTextLength();
			    if (tspan.node().getComputedTextLength() > width) {
				line.pop();
				tspan.text(line.join(" "));
				line = [word];
				++lineNumber;
				tspan = text.append("tspan").attr("x", function(d) { return d.children || d._children ? -10 : 10; }).attr("y", 0).attr("dy", lineNumber * lineHeight + dy*2 + "em").text(word);
			    }
			}
		    });
		}
	    
	    // Ajout de l'axe Y au SVG avec 6 éléments de légende en utilisant la fonction ticks (sinon D3JS en place autant qu'il peut).
	    svgc.append("g")
		.call(d3.axisLeft(y).ticks(6));

	    // Ajout des bars en utilisant les données de notre fichier data.tsv
	    // La largeur de la barre est déterminée par la fonction x
	    // La hauteur par la fonction y en tenant compte de la population
	    // La gestion des events de la souris pour le popup
	    svgc.selectAll(".bar")
		.data(csv_selected)
	    .enter().append("rect")
		.attr("class", "bar")
		.attr("x", function(d) { return x(d.CODE_DEPT); })
		.attr("width", x.bandwidth())
		.attr("y", function(d) { return y(d.total/10); })
		.attr("height", function(d) { return height_c - y(d.total/10); })		
		.attr("class","q5-9")
		.style("opacity",.8)
		.on("mouseover", function(d) {
		    divc.transition()        
		        .duration(200)      
		        .style("opacity", .9);
		    divc.html("Nbr de réponse : " + d.total)
		        .style("left", (d3.event.pageX + 10) + "px")     
		        .style("top", (d3.event.pageY - 50) + "px")
			.style("height","15px");
		    
		    
			
		})
		.on("mouseout", function(d) {
		    divc.transition()
		        .duration(500)
		        .style("opacity", 0);
		})
		.transition()
    			.duration(2000)
    			.attr("y", function(d) { return y(d.total); })
    			.attr("height", function(d) { return height_c - y(d.total); });
		
		svgc.append("text")
            		.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            		.attr("transform", "translate(-70, 120)rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            		.text("Nbr de contributions");

		function plot_quantile(quantile_s, resp) {

			const svgc_c = d3.select("#chart_q_"+theme).append("svg")
		    		.attr("id", "svgc_c"+theme)
				.attr("class","svgc_c")
		    		.attr("width", width_c + margin_c.left + margin_c.right)
		    		.attr("height", height_c + margin_c.top + margin_c.bottom)
		    		.append("g")
		    		.attr("transform", "translate(" + margin_c.left + "," + margin_c.top + ")")
				.attr("class",dic_color["perc_"+theme]);

			var csv_select_q = csv_chart.filter(function (d) { return d.label == quantile_s;});
	
			if (quantile_s =="Type d'agglomération") {
				var x1 = d3.scaleBand()
	    			.range([0, width_c])
	    			.padding(0.3)
				.domain(csv_select_q.map(function(d) { return d.quantile; }));
			
				svgc_c.append("g")
				.attr("transform", "translate(0," + height_c + ")")
				.call(d3.axisBottom(x1).tickSize(0))
				.selectAll("text")	
				    .style("text-anchor", "end")
				    .attr("dx", "-.8em")
				    .attr("dy", ".15em")
				    .attr("y", "0")
				    .attr("transform", "rotate(-65)");
				}
            		
			else 	{	
				var x1 = d3.scaleLinear()
	    			.range([0, width_c])
				.domain([0,d3.max(csv_select_q,function(d) { return d.quantile; })]);
				svgc_c.append("g")
				.attr("transform", "translate(0," + height_c + ")")
				.call(d3.axisBottom(x1).ticks(10))
				.selectAll("text")	
				    .style("text-anchor", "end")
				    //.attr("dx", "-.8em")
				    .attr("dy", ".15em")
				    .attr("y", "25");
				    //.attr("transform", "rotate(-65)");
				 svgc_c.append("text")
            				.attr("text-anchor", "middle")  
            				.attr("transform", "translate(200, 330)")  
            				.text(quantile_s+" de la commune (décile)");
				svgc_c.append("text")
            				.attr("text-anchor", "middle")  
					.style("opactiy", "0.5")
					.style("font-size","0.7em")
					.style("font-style", "italic")
            				.attr("transform", "translate(200, 350)")  
            				.text("(Le décile 9 correspond aux 10% des communes avec le "+quantile_s+" le plus élevé)");
				
			 }
			
	    			//.padding(0.3);
			var max_= d3.max(csv_select_q, function(d) { return d[resp]; });
			max_=parseFloat(max_)*1.1;
			var min_ =d3.min(csv_select_q, function(d) { return d[resp]; });
			min_=parseFloat(min_)*0.9;
		    	y.domain([min_,max_]);
			
		    
		    // Ajout de l'axe Y au SVG avec 6 éléments de légende en utilisant la fonction ticks (sinon D3JS en place autant qu'il peut).
		    	svgc_c.append("g")
				.call(d3.axisLeft(y).ticks(6));
			svgc_c.selectAll("circle")
				.data(csv_select_q)
				.enter()
				.append("circle")
				.attr('cx', function(d){return x1(d.quantile);})
				.attr("cy", function (d) {return y(d[resp]);})
		   		.attr("r",5)
				.style("opacity", .8)
				.attr("class","q5-9")
			svgc_c.append("text")
            			.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            			.attr("transform", "translate(-70, 120)rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            			.text("% de réponses");
		};

		
			
		d3.select('#select_resp_'+theme).on('change', function(){
				
				quantile.domain([ d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }), d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }	)]);
				
		   		 csv_dep.forEach(function(e,i) {
					d3.select("#d_"+theme+"_" + e.CODE_DEPT)
						.attr("class", "department q" + quantile(+e[d3.select("#select_resp_"+theme).node().value]) + "-9")
						.on("mouseover", function(l) {
							divmc.transition()        
								.duration(200)      
								.style("opacity", .9);
							divmc.html("<b>Département : </b>" + e.CODE_DEPT + "<br>"
								+ "<b>Valeur : </b>" + Math.round(e[d3.select("#select_resp_"+theme).node().value]*100)/100 + "<br>")
							.style("left", (d3.event.pageX + 30) + "px")     
							.style("top", (d3.event.pageY - 30) + "px");});
					
					
			});
		    
		    legendScale.domain([d3.min(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; }), d3.max(csv_dep, function(e) { return +e[d3.select("#select_resp_"+theme).node().value]; })]);
		    legendAxis.call(d3.axisRight(legendScale).ticks(6));
		    title.html(d3.select("#select_resp_"+theme).node().selectedOptions[0].innerHTML +" en %");
		    d3.select('#svgc_c'+theme).remove();
		    plot_quantile(quantile_select,d3.select("#select_resp_"+theme).node().value);
			});

		
		
	
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button "+dic_color["perc_"+theme]+" q3-7")
			.text("Revenu médian")
			.on("click", function() {
				quantile_select = "Revenu médian";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("Type d'agglomération")
			.on("click", function() {
				quantile_select = "Type d'agglomération";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Ouvriers")
			.on("click", function() {
				quantile_select = "% Ouvriers";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Employés")
			.on("click", function() {
				quantile_select = "% Employés";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Retraités")
			.on("click", function() {
				quantile_select = "% Retraités";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
		d3.select("#chart_q_"+theme).append("button")
			.attr("type","button")
			.attr("class","button")
			.text("% Cadre et prof. Int. Sup.")
			.on("click", function() {
				quantile_select = "% Cadre et prof. Int. Sup.";
				d3.select('#svgc_c'+theme).remove();
				plot_quantile(quantile_select,d3.select('#select_resp_'+theme).node().value);
				
			});
			
		
		
		
		
		plot_quantile(quantile_select,d3.select("#select_resp_"+theme).node().value);
	
};



promises.push('ecolo');
Promise.all(promises).then(plot_map_chart);
promises.pop('ecolo');
// Append a DIV for the tooltip
var div = d3.select("body").append("div")   
	.attr("class", "tooltip_n")               
	.style("opacity", 0);

d3.select("#select_chart_ecolo").on("change", function() {
	promises.push('ecolo');
	d3.select("#svgc_ecolo").remove();
	d3.select("#svgm_ecolo").remove();
	d3.select("#svgc_cecolo").remove();
	d3.select("#chart_q_ecolo").selectAll("*").remove();
	d3.select("#title_ecolo").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	//data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('ecolo');


});



promises.push('fisc');
Promise.all(promises).then(plot_map_chart);
promises.pop('fisc');



d3.select("#select_chart_fisc").on("change", function() {
	promises.push('fisc');
	d3.select("#svgc_fisc").remove();
	d3.select("#svgm_fisc").remove();
	d3.select("#svgc_cfisc").remove();
	d3.select("#chart_q_fisc").selectAll("*").remove();
	d3.select("#title_fisc").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('fisc');


});	

promises.push('cit');
Promise.all(promises).then(plot_map_chart);
promises.pop('cit');



d3.select("#select_chart_cit").on("change", function() {
	promises.push('cit');
	d3.select("#svgc_cit").remove();
	d3.select("#svgm_cit").remove();
	d3.select("#svgc_ccit").remove();
	d3.select("#chart_q_cit").selectAll("*").remove();
	d3.select("#title_cit").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	//data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('cit');


});	

promises.push('etat');
Promise.all(promises).then(plot_map_chart);
promises.pop('etat');



d3.select("#select_chart_etat").on("change", function() {
	promises.push('etat');
	d3.select("#svgc_etat").remove();
	d3.select("#svgm_etat").remove();
	d3.select("#svgc_cetat").remove();
	d3.select("#chart_q_etat").selectAll("*").remove();
	d3.select("#title_etat").remove();
	//d3.selectAll("#svgn").attr("class", dic_color["perc_"+this.value]);
	data_id_selected = this.value.toString();
	Promise.all(promises).then(plot_map_chart);
	promises.pop('etat');


});	



			
</script>
</body>

